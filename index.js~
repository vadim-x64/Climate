let temperature = 20;
let fanSpeed = 4;
let humidity = 64;
let autoFanControl = true;

let tempPlusTimer = null;
let tempMinusTimer = null;
let fanPlusTimer = null;
let fanMinusTimer = null;
let humidityPlusTimer = null;
let humidityMinusTimer = null;

const tempValue = document.getElementById('temp-value');
const fanValue = document.getElementById('fan-value');
const humidityValue = document.getElementById('humidity-value');
const summary = document.getElementById('summary');
const autoModeElement = document.getElementById('auto-mode');

const tempPlus = document.getElementById('temp-plus');
const tempMinus = document.getElementById('temp-minus');
const fanPlus = document.getElementById('fan-plus');
const fanMinus = document.getElementById('fan-minus');
const humidityPlus = document.getElementById('humidity-plus');
const humidityMinus = document.getElementById('humidity-minus');

updateFanAnimation();
updateFanColor();

function calculateFanSpeed(temp) {
    return Math.min(10, Math.max(0, Math.floor(temp / 5)));
}

function increaseTemperature() {
    if (temperature < 50) {
        temperature++;

        if (autoFanControl) {
            const newFanSpeed = calculateFanSpeed(temperature);

            if (newFanSpeed !== fanSpeed) {
                fanSpeed = newFanSpeed;
                updateFanAnimation();
            }
        }

        updateFanColor();
        updateUI();
    }
}

function decreaseTemperature() {
    if (temperature > 0) {
        temperature--;

        if (autoFanControl) {
            const newFanSpeed = calculateFanSpeed(temperature);

            if (newFanSpeed !== fanSpeed) {
                fanSpeed = newFanSpeed;
                updateFanAnimation();
            }
        }

        updateFanColor();
        updateUI();
    }
}

function increaseFanSpeed() {
    if (fanSpeed < 10) {
        autoFanControl = false;
        updateAutoModeUI();
        fanSpeed++;
        updateUI();
        updateFanAnimation();
    }
}

function decreaseFanSpeed() {
    if (fanSpeed > 0) {
        autoFanControl = false;
        updateAutoModeUI();
        fanSpeed--;
        updateUI();
        updateFanAnimation();
    }
}

function increaseHumidity() {
    if (humidity < 100) {
        humidity++;
        updateUI();
    }
}

function decreaseHumidity() {
    if (humidity > 0) {
        humidity--;
        updateUI();
    }
}

function toggleAutoMode() {
    autoFanControl = !autoFanControl;

    if (autoFanControl) {
        const newFanSpeed = calculateFanSpeed(temperature);
        if (newFanSpeed !== fanSpeed) {
            fanSpeed = newFanSpeed;
            updateFanAnimation();
        }
    }

    updateAutoModeUI();
    updateUI();
}

function updateAutoModeUI() {
    if (autoModeElement) {
        autoModeElement.textContent = autoFanControl ? 'Авто: Увімкнуто' : 'Авто: Вимкнуто';
        autoModeElement.classList.toggle('active', autoFanControl);
    }
}

function updateFanColor() {
    const fanBlades = document.querySelectorAll('.fan-blade');
    const fanCenter = document.querySelector('.fan-center');

    if (temperature <= 25) {
        fanBlades.forEach(blade => {
            blade.style.backgroundColor = 'var(--primary-color)';
        });

        if (fanCenter) {
            fanCenter.style.backgroundColor = 'var(--primary-hover)';
        }
    }
    else {
        const percentage = Math.min(100, ((temperature - 25) / 25) * 100);
        const r = Math.floor(59 + (220 - 59) * (percentage / 100));
        const g = Math.floor(130 - (130 - 38) * (percentage / 100));
        const b = Math.floor(246 - (246 - 38) * (percentage / 100));

        fanBlades.forEach(blade => {
            blade.style.backgroundColor = `rgb(${r}, ${g}, ${b})`;
        });

        const centerR = Math.max(0, r - 30);
        const centerG = Math.max(0, g - 30);
        const centerB = Math.max(0, b - 30);

        if (fanCenter) {
            fanCenter.style.backgroundColor = `rgb(${centerR}, ${centerG}, ${centerB})`;
        }

        document.documentElement.style.setProperty('--fan-color', `rgb(${r}, ${g}, ${b})`);
        document.documentElement.style.setProperty('--fan-center-color', `rgb(${centerR}, ${centerG}, ${centerB})`);
    }
}

function updateFanAnimation() {
    const fanElement = document.getElementById('fan');
    let currentRotation = 0;

    if (fanElement.style.animation && fanElement.style.animation !== 'none') {
        const transformStyle = window.getComputedStyle(fanElement).transform;

        if (transformStyle && transformStyle !== 'none') {
            const matrix = new DOMMatrix(transformStyle);
            currentRotation = Math.atan2(matrix.b, matrix.a) * (180 / Math.PI);
            if (currentRotation < 0) currentRotation += 360;
        }
    }

    fanElement.style.animation = 'none';
    fanElement.style.transform = `rotate(${currentRotation}deg)`;

    void fanElement.offsetWidth;

    if (fanSpeed === 0) {
        fanElement.style.animation = 'none';
    } else {
        const duration = 4 / fanSpeed;

        setTimeout(() => {
            fanElement.style.transform = '';
            fanElement.style.animation = `rotate ${duration}s linear infinite`;
            fanElement.style.transition = 'animation-duration 0.8s ease-in-out';
        }, 10);
    }
}

function updateUI() {
    tempValue.textContent = `${temperature}°C`;
    fanValue.textContent = fanSpeed;
    humidityValue.textContent = `${humidity}%`;

    let autoStatus = autoFanControl ? "(авто)" : "";
    summary.textContent = `Поточні налаштування: ${temperature}°C, швидкість вентилятора ${fanSpeed}${autoStatus}, вологість ${humidity}%`;

    if (temperature > 35) {
        const heatPercentage = Math.min(100, ((temperature - 35) / 15) * 100);
        tempValue.style.color = `rgba(220, ${150 - (heatPercentage * 1.5)}, 20, 1)`;
    } else {
        tempValue.style.color = '';
    }
}

tempPlus.addEventListener('mousedown', () => {
    increaseTemperature();
    tempPlusTimer = setTimeout(function() {
        tempPlusTimer = setInterval(increaseTemperature, 100);
    }, 500);
});

tempMinus.addEventListener('mousedown', () => {
    decreaseTemperature();
    tempMinusTimer = setTimeout(function() {
        tempMinusTimer = setInterval(decreaseTemperature, 100);
    }, 500);
});

fanPlus.addEventListener('mousedown', () => {
    increaseFanSpeed();
    fanPlusTimer = setTimeout(function() {
        fanPlusTimer = setInterval(increaseFanSpeed, 100);
    }, 500);
});

fanMinus.addEventListener('mousedown', () => {
    decreaseFanSpeed();
    fanMinusTimer = setTimeout(function() {
        fanMinusTimer = setInterval(decreaseFanSpeed, 100);
    }, 500);
});

humidityPlus.addEventListener('mousedown', () => {
    increaseHumidity();
    humidityPlusTimer = setTimeout(function() {
        humidityPlusTimer = setInterval(increaseHumidity, 100);
    }, 500);
});

humidityMinus.addEventListener('mousedown', () => {
    decreaseHumidity();
    humidityMinusTimer = setTimeout(function() {
        humidityMinusTimer = setInterval(decreaseHumidity, 100);
    }, 500);
});

if (autoModeElement) {
    autoModeElement.addEventListener('click', toggleAutoMode);
}

document.addEventListener('mouseup', () => {
    clearTimeout(tempPlusTimer);
    clearInterval(tempPlusTimer);
    clearTimeout(tempMinusTimer);
    clearInterval(tempMinusTimer);
    clearTimeout(fanPlusTimer);
    clearInterval(fanPlusTimer);
    clearTimeout(fanMinusTimer);
    clearInterval(fanMinusTimer);
    clearTimeout(humidityPlusTimer);
    clearInterval(humidityPlusTimer);
    clearTimeout(humidityMinusTimer);
    clearInterval(humidityMinusTimer);
});

document.addEventListener('mouseleave', () => {
    clearTimeout(tempPlusTimer);
    clearInterval(tempPlusTimer);
    clearTimeout(tempMinusTimer);
    clearInterval(tempMinusTimer);
    clearTimeout(fanPlusTimer);
    clearInterval(fanPlusTimer);
    clearTimeout(fanMinusTimer);
    clearInterval(fanMinusTimer);
    clearTimeout(humidityPlusTimer);
    clearInterval(humidityPlusTimer);
    clearTimeout(humidityMinusTimer);
    clearInterval(humidityMinusTimer);
});

tempValue.addEventListener('click', (event) => {
    if (event.offsetX < tempValue.offsetWidth / 2) {
        decreaseTemperature();
    } else {
        increaseTemperature();
    }
});

fanValue.addEventListener('click', (event) => {
    if (event.offsetX < fanValue.offsetWidth / 2) {
        decreaseFanSpeed();
    } else {
        increaseFanSpeed();
    }
});

humidityValue.addEventListener('click', (event) => {
    if (event.offsetX < humidityValue.offsetWidth / 2) {
        decreaseHumidity();
    } else {
        increaseHumidity();
    }
});
updateAutoModeUI();
updateFanColor();
updateUI();